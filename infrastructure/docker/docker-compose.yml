# Network Agent Appliance - Docker Compose
# Production-ready configuration with Caddy reverse proxy
#
# Usage:
#   Default (secure):     docker compose up -d
#   Host network (L2/L3): docker compose -f docker-compose.yml -f docker-compose.scan-mode.yml up -d
#   With SearXNG:         docker compose -f docker-compose.yml -f docker-compose.online.yml up -d

services:
  net-agent:
    image: ghcr.io/obtfusi/network-agent:${VERSION:-latest}
    container_name: net-agent
    hostname: net-agent
    restart: unless-stopped
    environment:
      - LLM_BASE_URL=http://ollama:11434/v1
      - LLM_MODEL=qwen3:30b-a3b
      - LLM_API_KEY=not-needed-for-ollama
      - DATABASE_URL=postgresql://${POSTGRES_USER:-agent}:${POSTGRES_PASSWORD}@postgres:5432/network_agent
    volumes:
      - ./config/agent-config.yaml:/app/config/settings.yaml:ro
      - agent-data:/app/data
    networks:
      - agent-net
    cap_add:
      - NET_RAW      # For nmap/ping
      - NET_ADMIN    # For masscan
    depends_on:
      ollama:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  ollama:
    image: ollama/ollama:0.14.1
    container_name: ollama
    hostname: ollama
    restart: unless-stopped
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - agent-net
    healthcheck:
      test: ["CMD", "ollama", "list"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  caddy:
    image: caddy:2.9-alpine
    container_name: caddy
    hostname: caddy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - agent-net
    environment:
      - BASIC_AUTH_USER=${BASIC_AUTH_USER:-admin}
      - BASIC_AUTH_HASH=${BASIC_AUTH_HASH}
    depends_on:
      net-agent:
        condition: service_healthy

  postgres:
    image: postgres:16.6-alpine
    container_name: postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-agent}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=network_agent
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - agent-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agent} -d network_agent"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  agent-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  agent-data:
  ollama-models:
    # Use external volume created during appliance build (contains pre-downloaded model)
    external: true
  postgres-data:
  caddy-data:
  caddy-config:
