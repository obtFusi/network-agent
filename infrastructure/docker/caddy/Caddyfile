# Network Agent Appliance - Caddy Reverse Proxy
# Provides TLS termination and Basic Auth protection

{
    # Use self-signed certs (appliance mode)
    auto_https disable_redirects

    # Disable admin API (security)
    admin off
}

# HTTPS with self-signed certificate
:443 {
    tls internal

    # Basic Auth protection
    # Credentials are generated on first boot
    basicauth /* {
        {$BASIC_AUTH_USER} {$BASIC_AUTH_HASH}
    }

    # Reverse proxy to net-agent
    reverse_proxy net-agent:8080 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 10s

        # Timeouts for long-running scans
        transport http {
            read_timeout 300s
            write_timeout 300s
        }
    }

    # Logging
    log {
        output stderr
        format console
        level INFO
    }
}

# HTTP redirect to HTTPS
:80 {
    redir https://{host}{uri} permanent
}
