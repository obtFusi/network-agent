# Network Agent Appliance - Caddy Reverse Proxy
# Provides TLS termination and Basic Auth protection

{
    # Use self-signed certs (appliance mode)
    auto_https disable_redirects

    # Disable admin API (security)
    admin off

    # Default SNI for IP-based access (no hostname in TLS handshake)
    # Required because clients don't send SNI when connecting to IP addresses
    default_sni network-agent
}

# HTTPS with self-signed certificate
# Use wildcard matcher to accept any hostname/IP
https:// {
    tls internal {
        on_demand
    }

    # Basic Auth protection
    # Credentials are generated on first boot
    basic_auth /* {
        {$BASIC_AUTH_USER} {$BASIC_AUTH_HASH}
    }

    # Open WebUI Chat Interface
    handle_path /chat* {
        reverse_proxy open-webui:8080
    }

    # Network Agent (default)
    handle {
        reverse_proxy net-agent:8080 {
            # Health check
            health_uri /health
            health_interval 30s
            health_timeout 10s

            # Timeouts for long-running scans
            transport http {
                read_timeout 300s
                write_timeout 300s
            }
        }
    }

    # Logging
    log {
        output stderr
        format console
        level INFO
    }
}

# HTTP redirect to HTTPS
:80 {
    redir https://{host}{uri} permanent
}
