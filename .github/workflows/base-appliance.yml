name: Base Appliance Build

# Monthly base image build (Debian + Docker + Ollama)
# Uploaded to MinIO appliance-base bucket for layered builds

on:
  workflow_dispatch:
    inputs:
      base_version:
        description: 'Base version (e.g., 2026-01)'
        required: true
        type: string
      ollama_model:
        description: 'Primary Ollama model'
        type: string
        default: 'qwen3:30b-a3b'
  schedule:
    # Run monthly on the 1st at 03:00 UTC
    - cron: '0 3 1 * *'

concurrency:
  group: base-appliance-build
  cancel-in-progress: false

env:
  PACKER_VERSION: "1.11.0"

permissions:
  contents: read

jobs:
  build-base:
    name: Build Base Image
    runs-on: self-hosted
    timeout-minutes: 60  # With cached models: ~30-40min instead of 90min
    outputs:
      base_version: ${{ steps.version.outputs.BASE_VERSION }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            registry-1.docker.io:443
            auth.docker.io:443
            production.cloudflare.docker.com:443
            cdimage.debian.org:443
            deb.debian.org:443
            security.debian.org:443
            registry.ollama.ai:443
            download.docker.com:443
            dl.min.io:443

      - uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [[ -n "${{ inputs.base_version }}" ]]; then
            BASE_VERSION="${{ inputs.base_version }}"
          else
            # Auto-generate from current month
            BASE_VERSION=$(date +%Y-%m)
          fi
          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Building base image: $BASE_VERSION"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zstd qemu-utils

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Verify KVM support
        run: |
          if [[ ! -e /dev/kvm ]]; then
            echo "ERROR: KVM not available. Self-hosted runner requires hardware virtualization."
            exit 1
          fi
          ls -la /dev/kvm

      - name: Cache Ollama models on runner
        env:
          OLLAMA_MODEL: ${{ inputs.ollama_model || 'qwen3:30b-a3b' }}
        run: |
          CACHE_DIR="/opt/ollama-cache"
          ARCHIVE_PATH="$CACHE_DIR/ollama-models.tar.zst"

          # Check if tarball cache exists (>1GB = valid)
          ARCHIVE_SIZE=$(stat -c%s "$ARCHIVE_PATH" 2>/dev/null || echo 0)
          if [[ "$ARCHIVE_SIZE" -gt 1000000000 ]]; then
            echo "âœ… Tarball cache exists ($(numfmt --to=iec $ARCHIVE_SIZE))"
            ls -lh "$ARCHIVE_PATH"
          else
            echo "ðŸ“¥ No tarball cache, downloading models..."
            sudo mkdir -p "$CACHE_DIR"
            sudo chown runner:runner "$CACHE_DIR"

            # Install Ollama on runner if not present
            if ! command -v ollama &> /dev/null; then
              curl -fsSL https://ollama.com/install.sh | sudo sh
            fi

            # Wait for Ollama service
            echo "â³ Waiting for Ollama service..."
            for i in {1..30}; do
              if curl -sf http://localhost:11434/api/tags > /dev/null 2>&1; then
                echo "âœ… Ollama ready"
                break
              fi
              sleep 2
            done

            # Ensure Ollama storage dir exists with correct permissions
            # Restart Ollama service to regenerate keys if needed
            sudo mkdir -p /usr/share/ollama/.ollama
            sudo chown -R ollama:ollama /usr/share/ollama
            sudo systemctl restart ollama
            sleep 3

            # Pull models (Ollama stores in /usr/share/ollama/.ollama/models)
            ollama pull "$OLLAMA_MODEL"
            ollama pull "qwen3:4b-instruct-2507-q4_K_M"

            # Create tarball DIRECTLY from Ollama storage (no copy = saves 40GB disk!)
            echo "ðŸ“¦ Creating tarball directly from Ollama storage..."
            cd /usr/share/ollama/.ollama
            sudo tar -cf - models/ | zstd -3 -T0 > "$ARCHIVE_PATH"
            sudo chown runner:runner "$ARCHIVE_PATH"
            echo "âœ… Tarball: $(ls -lh "$ARCHIVE_PATH" | awk '{print $5}')"

            # DELETE models after tarball is complete (saves 40GB)
            echo "ðŸ§¹ Cleaning up Ollama models..."
            sudo rm -rf /usr/share/ollama/.ollama/models
            df -h /
          fi

          # Symlink for Packer HTTP server (FAST: ~500MB/s vs SCP ~100MB/s)
          mkdir -p infrastructure/packer/http
          ln -sf "$ARCHIVE_PATH" infrastructure/packer/http/ollama-models.tar.zst

      - name: Initialize Packer
        working-directory: infrastructure/packer
        run: packer init base.pkr.hcl

      - name: Validate base template
        working-directory: infrastructure/packer
        run: |
          packer validate \
            -var "base_version=${{ steps.version.outputs.BASE_VERSION }}" \
            base.pkr.hcl

      - name: Build base qcow2 image
        working-directory: infrastructure/packer
        env:
          OLLAMA_MODEL: ${{ inputs.ollama_model || 'qwen3:30b-a3b' }}
        run: |
          echo "Building base image version: ${{ steps.version.outputs.BASE_VERSION }}"
          echo "Ollama model: $OLLAMA_MODEL"
          packer build \
            -var "base_version=${{ steps.version.outputs.BASE_VERSION }}" \
            -var "ollama_model=$OLLAMA_MODEL" \
            -on-error=abort \
            base.pkr.hcl

      - name: Verify build output
        run: |
          ls -lh infrastructure/packer/output-base/
          QCOW2_FILE=$(ls infrastructure/packer/output-base/*.qcow2)
          echo "Built image: $QCOW2_FILE"

      - name: Compress with zstd
        run: |
          cd infrastructure/packer/output-base
          BASE_VERSION="${{ steps.version.outputs.BASE_VERSION }}"

          echo "Compressing with zstd..."
          zstd -3 -T0 -v *.qcow2 -o "base-${BASE_VERSION}.qcow2.zst"

          echo "Compressed size:"
          ls -lh *.zst

          echo "Removing original qcow2..."
          rm -f *.qcow2

      - name: Generate checksum
        run: |
          cd infrastructure/packer/output-base
          sha256sum *.zst > SHA256SUMS
          cat SHA256SUMS

      - name: Upload to MinIO (appliance-base bucket)
        env:
          MINIO_ENDPOINT: ${{ secrets.MINIO_ENDPOINT }}
          MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
        run: |
          BASE_VERSION="${{ steps.version.outputs.BASE_VERSION }}"

          # Install mc client
          wget -q https://dl.min.io/client/mc/release/linux-amd64/mc -O /tmp/mc
          chmod +x /tmp/mc

          # Configure alias
          /tmp/mc alias set minio $MINIO_ENDPOINT $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

          # Upload to persistent base bucket
          /tmp/mc cp infrastructure/packer/output-base/base-${BASE_VERSION}.qcow2.zst minio/appliance-base/
          /tmp/mc cp infrastructure/packer/output-base/SHA256SUMS minio/appliance-base/SHA256SUMS-${BASE_VERSION}

          # Also upload as "latest" for convenience
          /tmp/mc cp infrastructure/packer/output-base/base-${BASE_VERSION}.qcow2.zst minio/appliance-base/base-latest.qcow2.zst

          # Verify upload
          echo "Uploaded to MinIO appliance-base:"
          /tmp/mc ls minio/appliance-base/

      - name: Cleanup
        if: always()
        run: |
          rm -rf infrastructure/packer/output-base/ || true
          sudo fstrim -av || true
          echo "Base image build complete and uploaded to MinIO"

      - name: Summary
        run: |
          BASE_VERSION="${{ steps.version.outputs.BASE_VERSION }}"
          echo "## Base Appliance Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $BASE_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Location:** MinIO appliance-base bucket" >> $GITHUB_STEP_SUMMARY
          echo "- **Files:**" >> $GITHUB_STEP_SUMMARY
          echo "  - \`base-${BASE_VERSION}.qcow2.zst\`" >> $GITHUB_STEP_SUMMARY
          echo "  - \`base-latest.qcow2.zst\` (symlink)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use this base image for layered appliance builds." >> $GITHUB_STEP_SUMMARY
