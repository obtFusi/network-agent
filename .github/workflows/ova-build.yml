# OVA Build Workflow
# Builds Network Agent appliance as OVA for VMware/VirtualBox
#
# SECURITY: This workflow runs on self-hosted runner.
# Only triggered by:
#   - workflow_dispatch (manual, maintainers only)
#   - release (published, maintainers only)
# NEVER triggered by pull_request (would allow fork code execution!)

name: OVA Build

on:
  workflow_dispatch:
    inputs:
      include_model:
        description: 'Include Qwen3 model in OVA (~20GB)'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  release:
    types: [published]

# Prevent concurrent builds (RAM-limited on Proxmox)
concurrency:
  group: ova-build
  cancel-in-progress: false

# Minimal permissions by default
permissions:
  contents: read

jobs:
  # Job 1: Validate on GitHub-hosted runner (fast, safe)
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Packer
        uses: hashicorp/setup-packer@1aa358be5cf73883762b302a3a03abd66e75b232 # v3.1.0
        with:
          version: "1.11.2"

      - name: Validate Packer template
        working-directory: infrastructure/packer
        run: packer validate network-agent-ova.pkr.hcl

      - name: Validate Docker Compose
        run: docker compose -f infrastructure/docker/docker-compose.yml config

  # Job 2: Build OVA on self-hosted runner (needs KVM, RAM)
  build-ova:
    runs-on: [self-hosted, ova-builder]
    needs: validate
    timeout-minutes: 180
    steps:
      # Security: Harden runner FIRST
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            ghcr.io:443
            docker.io:443
            registry-1.docker.io:443
            auth.docker.io:443
            production.cloudflare.docker.com:443
            cdimage.debian.org:443
            deb.debian.org:443
            security.debian.org:443
            ollama.ai:443
            registry.ollama.ai:443

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Packer
        uses: hashicorp/setup-packer@1aa358be5cf73883762b302a3a03abd66e75b232 # v3.1.0
        with:
          version: "1.11.2"

      - name: Initialize Packer
        working-directory: infrastructure/packer
        run: packer init .

      - name: Build OVA
        working-directory: infrastructure/packer
        run: |
          INCLUDE_MODEL="${{ github.event.inputs.include_model || 'true' }}"
          packer build -var "include_model=$INCLUDE_MODEL" network-agent-ova.pkr.hcl
        env:
          PACKER_LOG: 1

      - name: Calculate checksums
        run: |
          cd infrastructure/packer
          sha256sum network-agent-appliance.ova > network-agent-appliance.ova.sha256
          cat network-agent-appliance.ova.sha256

      - name: Upload OVA artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: network-agent-ova
          path: |
            infrastructure/packer/network-agent-appliance.ova
            infrastructure/packer/network-agent-appliance.ova.sha256
          retention-days: 7
          compression-level: 0  # OVA is already compressed

      - name: Cleanup build artifacts
        if: always()
        run: |
          rm -rf infrastructure/packer/output-*
          docker system prune -af --volumes 2>/dev/null || true

  # Job 3: User simulation test (optional, needs Proxmox API access)
  # Uncomment when Proxmox API secrets are configured
  # user-simulation-test:
  #   runs-on: [self-hosted, ova-builder]
  #   needs: build-ova
  #   if: github.event_name == 'release'
  #   timeout-minutes: 60
  #   steps:
  #     - name: Download OVA
  #       uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
  #       with:
  #         name: network-agent-ova
  #
  #     - name: Import and test OVA
  #       run: |
  #         # TODO: Add Proxmox API integration for VM import test
  #         echo "User simulation test not yet implemented"

  # Job 4: Upload to GitHub Release
  upload-release:
    runs-on: ubuntu-latest
    needs: build-ova
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download OVA artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: network-agent-ova

      - name: Upload to Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          files: |
            network-agent-appliance.ova
            network-agent-appliance.ova.sha256
