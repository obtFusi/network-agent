name: Appliance Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 0.4.0)'
        required: true
        type: string
      skip_test:
        description: 'Skip E2E test (for debugging)'
        type: boolean
        default: false
  release:
    types: [published]

concurrency:
  group: appliance-build
  cancel-in-progress: false

env:
  PACKER_VERSION: "1.11.0"
  TEST_VMID: 999

jobs:
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Initialize Packer
        working-directory: infrastructure/packer
        run: packer init .

      - name: Validate Packer template
        working-directory: infrastructure/packer
        run: packer validate network-agent.pkr.hcl

      - name: Validate docker-compose files
        run: |
          docker compose -f infrastructure/docker/docker-compose.yml config --quiet
          docker compose -f infrastructure/docker/docker-compose.yml \
                        -f infrastructure/docker/docker-compose.scan-mode.yml config --quiet
          docker compose -f infrastructure/docker/docker-compose.yml \
                        -f infrastructure/docker/docker-compose.online.yml config --quiet

  build-and-test:
    name: Build and Test
    runs-on: self-hosted
    needs: validate
    timeout-minutes: 120
    env:
      VERSION: ${{ inputs.version || github.ref_name }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            ghcr.io:443
            registry-1.docker.io:443
            auth.docker.io:443
            production.cloudflare.docker.com:443
            cdimage.debian.org:443
            deb.debian.org:443
            security.debian.org:443
            registry.ollama.ai:443
            download.docker.com:443

      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zstd qemu-utils

      - name: Setup Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Verify KVM support
        run: |
          if [[ ! -e /dev/kvm ]]; then
            echo "ERROR: KVM not available. Self-hosted runner requires hardware virtualization."
            exit 1
          fi
          ls -la /dev/kvm

      - name: Initialize Packer
        working-directory: infrastructure/packer
        run: packer init .

      # ═══════════════════════════════════════════════════════════
      # BUILD PHASE
      # ═══════════════════════════════════════════════════════════

      - name: Build qcow2 Image
        working-directory: infrastructure/packer
        run: |
          VERSION_CLEAN="${VERSION#v}"
          echo "Building version: $VERSION_CLEAN"
          packer build \
            -var "version=${VERSION_CLEAN}" \
            -on-error=abort \
            network-agent.pkr.hcl || true

      - name: Verify build output
        run: |
          ls -lh infrastructure/packer/output/
          QCOW2_FILE=$(ls infrastructure/packer/output/*.qcow2)
          echo "Built image: $QCOW2_FILE"
          echo "QCOW2_FILE=$QCOW2_FILE" >> $GITHUB_ENV

      - name: Compress with zstd
        run: |
          cd infrastructure/packer/output
          VERSION_CLEAN="${VERSION#v}"

          echo "Compressing with zstd (fast mode)..."
          zstd -1 -T0 -v *.qcow2 -o "network-agent-${VERSION_CLEAN}.qcow2.zst"

          echo "Compressed size:"
          ls -lh *.zst

          echo "Removing original qcow2 to free space..."
          rm -f *.qcow2
          df -h .

      - name: Split into parts
        run: |
          cd infrastructure/packer/output
          VERSION_CLEAN="${VERSION#v}"

          echo "Splitting into 1.9GB parts..."
          split -b 1900M -a 2 "network-agent-${VERSION_CLEAN}.qcow2.zst" "network-agent-${VERSION_CLEAN}.qcow2.zst.part-"

          # Rename numeric suffixes to alpha (aa, ab, ac, etc.)
          for f in *.part-[0-9][0-9]; do
            if [[ -f "$f" ]]; then
              num="${f##*.part-}"
              first=$(printf "\\x$(printf '%02x' $((97 + 10#$num / 26)))")
              second=$(printf "\\x$(printf '%02x' $((97 + 10#$num % 26)))")
              mv "$f" "${f%.part-*}.part-${first}${second}"
            fi
          done

          rm -f "network-agent-${VERSION_CLEAN}.qcow2.zst"
          echo "Parts created:"
          ls -lh *.part-*

      - name: Generate checksums
        run: |
          cd infrastructure/packer/output
          sha256sum *.part-* > SHA256SUMS
          cat SHA256SUMS

      - name: Copy install script
        run: |
          VERSION_CLEAN="${VERSION#v}"
          cp infrastructure/scripts/install-network-agent.sh infrastructure/packer/output/
          sed -i "s/VERSION:-0.4.0/VERSION:-${VERSION_CLEAN}/" infrastructure/packer/output/install-network-agent.sh

      # ═══════════════════════════════════════════════════════════
      # E2E TEST PHASE (uses local files, no download needed)
      # ═══════════════════════════════════════════════════════════

      - name: Prepare test directory
        if: ${{ inputs.skip_test != true }}
        run: |
          mkdir -p test
          cp infrastructure/packer/output/*.part-* test/
          cp infrastructure/packer/output/SHA256SUMS test/

      - name: Reassemble image (simulates user download)
        if: ${{ inputs.skip_test != true }}
        run: |
          cd test
          VERSION_CLEAN="${VERSION#v}"

          echo "Reassembling parts..."
          cat network-agent-*.part-* > network-agent.qcow2.zst

          echo "Verifying checksums..."
          sha256sum -c SHA256SUMS

          echo "Decompressing..."
          zstd -d -f network-agent.qcow2.zst -o network-agent-test.qcow2

          ls -lh network-agent-test.qcow2

      - name: Create test VM
        if: ${{ inputs.skip_test != true }}
        env:
          PVE_HOST: 10.0.0.69
        run: |
          # Copy qcow2 to Proxmox host
          echo "Copying qcow2 to Proxmox host..."
          scp -o StrictHostKeyChecking=no test/network-agent-test.qcow2 root@$PVE_HOST:/tmp/

          # Clean up any existing test VM
          ssh -o StrictHostKeyChecking=no root@$PVE_HOST "qm stop $TEST_VMID 2>/dev/null || true"
          ssh root@$PVE_HOST "qm destroy $TEST_VMID --purge 2>/dev/null || true"

          # Create VM on Proxmox host
          ssh root@$PVE_HOST "qm create $TEST_VMID \
            --name 'network-agent-test' \
            --memory 32768 \
            --cores 8 \
            --cpu host \
            --ostype l26 \
            --agent enabled=1 \
            --net0 virtio,bridge=vmbr0"

          # Import disk
          ssh root@$PVE_HOST "qm importdisk $TEST_VMID /tmp/network-agent-test.qcow2 local-lvm --format qcow2"

          # Configure disk
          ssh root@$PVE_HOST "DISK=\$(pvesm list local-lvm | grep 'vm-${TEST_VMID}-disk' | awk '{print \$1}') && \
            qm set $TEST_VMID --scsi0 \"\$DISK\" --boot order=scsi0 --scsihw virtio-scsi-single"

          # Start VM
          ssh root@$PVE_HOST "qm start $TEST_VMID"

          # Cleanup temp file on Proxmox
          ssh root@$PVE_HOST "rm -f /tmp/network-agent-test.qcow2"

      - name: Wait for boot and get IP
        if: ${{ inputs.skip_test != true }}
        id: vm-ip
        env:
          PVE_HOST: 10.0.0.69
        run: |
          echo "Waiting for VM to boot..."
          sleep 60

          VM_IP=""
          for i in {1..30}; do
            VM_IP=$(ssh root@$PVE_HOST "qm guest cmd $TEST_VMID network-get-interfaces" 2>/dev/null | \
                    jq -r '.[1]["ip-addresses"][]? | select(.["ip-address-type"] == "ipv4") | .["ip-address"]' 2>/dev/null | head -1 || echo "")

            if [[ -n "$VM_IP" && "$VM_IP" != "null" && "$VM_IP" != "127.0.0.1" ]]; then
              echo "VM_IP=$VM_IP" >> $GITHUB_OUTPUT
              echo "VM IP: $VM_IP"
              break
            fi
            echo "Waiting for IP... ($i/30)"
            sleep 10
          done

          if [[ -z "$VM_IP" || "$VM_IP" == "null" ]]; then
            echo "ERROR: Failed to get VM IP"
            echo ""
            echo "=== DEBUG: Network Interfaces ==="
            ssh root@$PVE_HOST "qm guest cmd $TEST_VMID network-get-interfaces" || true
            echo ""
            echo "=== DEBUG: systemd-networkd status ==="
            ssh root@$PVE_HOST "qm guest exec $TEST_VMID -- bash -lc 'systemctl is-enabled systemd-networkd; systemctl is-active systemd-networkd'" | jq -r '.["out-data"] // "no output"' || true
            echo ""
            echo "=== DEBUG: networkctl status ==="
            ssh root@$PVE_HOST "qm guest exec $TEST_VMID -- bash -lc 'networkctl status ens18 2>&1 || networkctl list'" | jq -r '.["out-data"] // "no output"' || true
            echo ""
            echo "=== DEBUG: ip link show ==="
            ssh root@$PVE_HOST "qm guest exec $TEST_VMID -- bash -lc 'ip link show'" | jq -r '.["out-data"] // "no output"' || true
            echo ""
            echo "=== DEBUG: journalctl systemd-networkd (last 50 lines) ==="
            ssh root@$PVE_HOST "qm guest exec $TEST_VMID -- bash -lc 'journalctl -b -u systemd-networkd --no-pager | tail -50'" | jq -r '.["out-data"] // "no output"' || true
            echo ""
            echo "=== DEBUG: /etc/systemd/network/ contents ==="
            ssh root@$PVE_HOST "qm guest exec $TEST_VMID -- bash -lc 'ls -la /etc/systemd/network/ && cat /etc/systemd/network/20-wired.network'" | jq -r '.["out-data"] // "no output"' || true
            echo ""
            echo "=== DEBUG: Other network managers ==="
            ssh root@$PVE_HOST "qm guest exec $TEST_VMID -- bash -lc 'systemctl is-active NetworkManager 2>/dev/null || echo inactive; systemctl is-active networking.service 2>/dev/null || echo inactive'" | jq -r '.["out-data"] // "no output"' || true
            exit 1
          fi

      - name: Configure and start services
        if: ${{ inputs.skip_test != true }}
        run: |
          VM_IP="${{ steps.vm-ip.outputs.VM_IP }}"

          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 root@$VM_IP bash << 'EOF'
            printf '%s\n' \
              'POSTGRES_USER=agent' \
              'POSTGRES_PASSWORD=test-password-123' \
              'BASIC_AUTH_USER=admin' \
              'BASIC_AUTH_HASH=$2a$14$test.hash.for.testing.only' \
              'VERSION=test' \
              > /opt/network-agent/.env
            chmod 600 /opt/network-agent/.env

            mkdir -p /var/lib/network-agent
            touch /var/lib/network-agent/.initialized

            cd /opt/network-agent
            docker compose up -d
          EOF

      - name: Wait for services
        if: ${{ inputs.skip_test != true }}
        run: |
          VM_IP="${{ steps.vm-ip.outputs.VM_IP }}"
          echo "Waiting for services..."
          sleep 120
          ssh -o StrictHostKeyChecking=no root@$VM_IP "docker compose -f /opt/network-agent/docker-compose.yml ps"

      - name: Run health checks
        if: ${{ inputs.skip_test != true }}
        run: |
          VM_IP="${{ steps.vm-ip.outputs.VM_IP }}"

          echo "=== Checking Ollama ==="
          if ssh -o StrictHostKeyChecking=no root@$VM_IP "docker exec ollama curl -sf http://localhost:11434/api/tags | grep -q qwen3"; then
            echo "✓ Ollama model loaded"
          else
            echo "✗ Ollama model not found"
            ssh -o StrictHostKeyChecking=no root@$VM_IP "docker logs ollama --tail 50" || true
          fi

          echo "=== Checking PostgreSQL ==="
          if ssh -o StrictHostKeyChecking=no root@$VM_IP "docker exec postgres pg_isready -U agent"; then
            echo "✓ PostgreSQL is ready"
          else
            echo "✗ PostgreSQL not ready"
          fi

          echo "=== Final status ==="
          ssh -o StrictHostKeyChecking=no root@$VM_IP "docker compose -f /opt/network-agent/docker-compose.yml ps"

      - name: Cleanup test VM
        # Only cleanup on success - keep VM for debugging on failure
        if: success()
        env:
          PVE_HOST: 10.0.0.69
        run: |
          ssh root@$PVE_HOST "qm stop $TEST_VMID 2>/dev/null || true"
          sleep 5
          ssh root@$PVE_HOST "qm destroy $TEST_VMID --purge 2>/dev/null || true"
          rm -rf test/

      # ═══════════════════════════════════════════════════════════
      # UPLOAD (only after successful test)
      # ═══════════════════════════════════════════════════════════

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: appliance-${{ env.VERSION }}
          path: |
            infrastructure/packer/output/*.part-*
            infrastructure/packer/output/SHA256SUMS
            infrastructure/packer/output/install-network-agent.sh
          retention-days: 7

  release:
    name: Upload to Release
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: appliance-${{ github.ref_name }}
          path: ./artifacts

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.part-*
            artifacts/SHA256SUMS
            artifacts/install-network-agent.sh
          fail_on_unmatched_files: true
