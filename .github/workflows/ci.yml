name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt
      # Konsistent: ruff aus requirements-dev.txt (Version gepinnt)
      - run: pip install -r requirements-dev.txt
      - run: ruff format --check .
      - run: ruff check agent/ tools/ cli.py
      # Bidi/Unicode Trojaner Check (CVE-2021-42574)
      # Scannt: Python, YAML, Markdown, Dockerfile (Workflow-Manipulation!)
      - name: Check for hidden Unicode characters
        run: |
          if grep -rP '[\x{200B}-\x{200F}\x{202A}-\x{202E}\x{2066}-\x{2069}]' \
            --include='*.py' --include='*.yml' --include='*.yaml' \
            --include='*.md' --include='Dockerfile*' .; then
            echo "::error::Hidden Unicode/Bidi characters found!"
            exit 1
          fi

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-dev.txt
      - run: pip install -r requirements-dev.txt
      - run: pytest --cov=agent --cov=tools --cov-report=term-missing

  security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - run: pip install pip-audit
      # Explizit requirements.txt auditen (nicht "magisch" installierte Packages)
      - run: pip-audit -r requirements.txt

  docker:
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    steps:
      - uses: actions/checkout@v6
      - run: docker build -t network-agent:ci .
      # Smoke-Test: Container startet und --version funktioniert
      # Verifiziert: cli.py:78-79 (--version Flag), Dockerfile:17 (CMD)
      - run: docker run --rm network-agent:ci python cli.py --version
      # Container Security Scan (gepinnt auf Release-Tag!)
      # ignore-unfixed: true -> Base-Image CVEs ohne Fix blockieren CI nicht
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'network-agent:ci'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
