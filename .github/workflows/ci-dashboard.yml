name: CI Dashboard

on:
  push:
    branches: [main]
    paths:
      - 'infrastructure/cicd-dashboard/**'
      - '.github/workflows/ci-dashboard.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infrastructure/cicd-dashboard/**'
      - '.github/workflows/ci-dashboard.yml'

concurrency:
  group: ci-dashboard-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    working-directory: infrastructure/cicd-dashboard

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: infrastructure/cicd-dashboard/requirements.txt
      - run: pip install ruff
      - run: ruff format --check .
      - run: ruff check app/ tests/

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: infrastructure/cicd-dashboard/requirements.txt
      - run: pip install -r requirements.txt
      - run: pytest -v --tb=short

  docker:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v6
      - name: Build Docker image
        run: docker build -t cicd-dashboard:ci .
      - name: Smoke test - health endpoint
        run: |
          docker run -d --name dashboard-test -p 8081:8080 cicd-dashboard:ci
          sleep 5
          curl -sf http://localhost:8081/health | grep -q '"status":"healthy"'
          docker stop dashboard-test
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: 'cicd-dashboard:ci'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
